---
layout: post
title:  "JPA分页查询中缺陷"
categories: 数据库
tag: JPA
---

使用jpa进行分页查询，查询的主要对象同时关联了其他对象，也是通过jpa的注解进行关联。现在这个主要对象的列表高达7万个，每个列表项目又关联了2个子对象，子对象一共有14万个。在进行分页查询时，主对象按照分页规定的大小返回了列表，但是其关联的子对象却没有根据分页来查询，而是把所有符合条件的主对象关联的子对象都查出来了，造成内存消耗很大。

子对象和主对象的关联方式是fetchmode=subselect，这种方式会生成一个in查询，in是主对象的列表。而in里面的的查询并没有分页条件，造成查出7万条数据，内存大量被占用。

通过将fetchmode由subselect改为join模式，jpa会先查出主对象列表，然后根据每一个列表项目发起一个子对象查询，这种方式虽然会发起多个sql查询，但是不会出现上面内存被大量占用的情况。

[^fetchmode]: jpa注解，用来控制取得子对象的方式

